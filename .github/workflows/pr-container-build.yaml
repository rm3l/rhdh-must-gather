name: PR container image build

on:
  # /!\ Warning: using the pull_request_target event to be able to read secrets. But using this event without the cautionary measures described below
  # may allow unauthorized GitHub users to open a “pwn request” and exfiltrate secrets.
  # As recommended in https://iterative.ai/blog/testing-external-contributions-using-github-actions-secrets,
  # we are adding an 'authorize' job that checks if the workflow was triggered from a fork PR. In that case, the "external" environment
  # will prevent the job from running until it's approved manually by human intervention.
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - release-1.[0-9]+

env:
  IMAGE_NAME: ${{ vars.REGISTRY_ORG }}/rhdh-must-gather

jobs:
  authorize:
    # The 'external' environment is configured with the repo maintainers team as required reviewers.
    # All the subsequent jobs in this workflow 'need' this job, which will require manual approval for PRs coming from external forks.
    # see list of approvers in OWNERS file
    environment:
      ${{ (github.event.pull_request.head.repo.full_name == github.repository ||
      contains(fromJSON('["gazarenkov","nickboldt","rm3l","kim-tsao","kadel","Fortune-Ndlovu","subhashkhileri","zdrapela","openshift-cherrypick-robot"]'), github.event.pull_request.user.login)) && 'internal' || 'external' }}
    runs-on: ubuntu-latest
    steps:
      - name: approved
        run: |
          echo "✓"

  pr-image-publish:
    name: Publish PR Container Image
    runs-on: ubuntu-latest
    needs: authorize
    permissions:
      contents: read
      packages: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          fetch-depth: 0
          repository: ${{github.event.pull_request.head.repo.full_name}}
          ref: ${{ github.event.pull_request.head.sha }}

      # check changes in this commit for regex include and exclude matches
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47.0.0
        with:
          files: |
            .github/workflows/pr-container-build.yaml
            Makefile
            Dockerfile
            .containerignore
            collection-scripts/**
            LICENSE
          files_ignore: |
            **/*.md
            **/*.adoc
            examples/**

      - name: List all changed files (for troubleshooting)
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          for file in ${ALL_CHANGED_FILES}; do
            echo "$file was changed"
          done

      # Login to Quay.io (only for PRs from same repo)
      # https://github.com/docker/login-action
      - name: Log into registry ${{ vars.REGISTRY }}
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.5.0
        with:
          registry: ${{ vars.REGISTRY }}
          username: ${{ vars.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_TOKEN }}

      # Generate image tags and build args
      - name: Prepare build variables
        if: steps.changed-files.outputs.any_changed == 'true'
        id: prep
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          SHORT_SHA=$(git rev-parse --short=9 HEAD)
          VERSION="0.0.0-$(git describe --no-match --always --abbrev=9 --dirty --broken 2>/dev/null || echo unknown)"
          
          # Calculate expiration date (2 weeks from now in ISO 8601 format)
          EXPIRATION_DATE=$(date -u -d "+14 days" +"%Y-%m-%dT%H:%M:%SZ")
          
          echo "IMAGE_TAG=pr-${PR_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "EXTRA_TAGS=pr-${PR_NUMBER}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "BUILD_ARGS=--build-arg RHDH_MUST_GATHER_VERSION=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "VERSION=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "EXPIRATION_DATE=${EXPIRATION_DATE}" >> "$GITHUB_OUTPUT"

      - name: Build and push main tag
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          make build-push \
            CONTAINER_TOOL=docker \
            REGISTRY=${{ vars.REGISTRY }} \
            IMAGE_NAME=${{ env.IMAGE_NAME}} \
            IMAGE_TAG=${{ steps.prep.outputs.IMAGE_TAG }} \
            BUILD_ARGS="${{ steps.prep.outputs.BUILD_ARGS }}"

      # Tag and push extra tag with commit SHA (reuses same digest)
      - name: Tag and push extra tag with commit SHA
        if: steps.changed-files.outputs.any_changed == 'true' && steps.prep.outputs.EXTRA_TAGS != ''
        run: |
          docker tag ${{ vars.REGISTRY }}/${{ env.IMAGE_NAME}}:${{ steps.prep.outputs.IMAGE_TAG }} \
            ${{ vars.REGISTRY }}/${{ env.IMAGE_NAME}}:${{ steps.prep.outputs.EXTRA_TAGS }}
          docker push ${{ vars.REGISTRY }}/${{ env.IMAGE_NAME}}:${{ steps.prep.outputs.EXTRA_TAGS }}

      # Set expiration on both tags via Quay.io API
      # Note: This requires an OAuth Application token, not a robot account token
      # Create an OAuth app in Quay.io and store the token as QUAY_OAUTH_TOKEN secret
      - name: Set expiration on PR images
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          # Use QUAY_OAUTH_TOKEN if available, otherwise fall back to QUAY_TOKEN
          API_TOKEN: ${{ secrets.QUAY_OAUTH_TOKEN || secrets.QUAY_TOKEN }}
        run: |
          # Extract namespace and repo name from IMAGE_NAME
          NAMESPACE=$(echo "${{ env.IMAGE_NAME }}" | cut -d'/' -f1)
          REPO=$(echo "${{ env.IMAGE_NAME }}" | cut -d'/' -f2)
          
          # Set expiration for main tag
          echo "Setting expiration on ${{ steps.prep.outputs.IMAGE_TAG }} to ${{ steps.prep.outputs.EXPIRATION_DATE }}"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT \
            -H "Authorization: Bearer ${API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"expiration\": \"${{ steps.prep.outputs.EXPIRATION_DATE }}\"}" \
            "https://${{ vars.REGISTRY }}/api/v1/repository/${NAMESPACE}/${REPO}/tag/${{ steps.prep.outputs.IMAGE_TAG }}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -ne 200 ] && [ "$HTTP_CODE" -ne 201 ]; then
            echo "Warning: Failed to set expiration on main tag (HTTP $HTTP_CODE): $BODY"
            echo "This may be due to using a robot account token instead of an OAuth application token"
          else
            echo "✓ Expiration set successfully on main tag"
          fi
          
          # Set expiration for extra tag
          if [ -n "${{ steps.prep.outputs.EXTRA_TAGS }}" ]; then
            echo "Setting expiration on ${{ steps.prep.outputs.EXTRA_TAGS }} to ${{ steps.prep.outputs.EXPIRATION_DATE }}"
            RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT \
              -H "Authorization: Bearer ${API_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "{\"expiration\": \"${{ steps.prep.outputs.EXPIRATION_DATE }}\"}" \
              "https://${{ vars.REGISTRY }}/api/v1/repository/${NAMESPACE}/${REPO}/tag/${{ steps.prep.outputs.EXTRA_TAGS }}")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" -ne 200 ] && [ "$HTTP_CODE" -ne 201 ]; then
              echo "Warning: Failed to set expiration on extra tag (HTTP $HTTP_CODE): $BODY"
            else
              echo "✓ Expiration set successfully on extra tag"
            fi
          fi

      # Comment with image links on the PR
      - name: Comment image links in PR
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'PR images are available:<br/><ol><li>https://${{ vars.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.prep.outputs.IMAGE_TAG }}</li><li>https://${{ vars.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.prep.outputs.EXTRA_TAGS }}</li></ol>'
            })

      - name: Summary
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "### Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.prep.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Number**: ${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ✅ Built, pushed, and signed" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags**: \`pr-${{ github.event.pull_request.number }}\`, \`${{ steps.prep.outputs.EXTRA_TAGS }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Expiry**: 2 weeks" >> $GITHUB_STEP_SUMMARY
