#!/bin/bash

# RHDH Must-Gather Tool - Main Orchestrator
# Collects diagnostic information for Red Hat Developer Hub troubleshooting
# Supports both OpenShift and standard Kubernetes clusters
# Handles both Helm and Operator deployments

set -euo pipefail

# Source utilities
source "$(dirname "$0")/lib/utils.sh"

# Get script directory for calling other scripts
SCRIPT_DIR="$(get_script_dir)"

# Execute a collection script and handle errors
run_collection_script() {
    local script_name="$1"
    local script_path="$SCRIPT_DIR/$script_name"
    local description="$2"
    
    log_info "Running: $description"
    
    if [[ ! -f "$script_path" ]]; then
        log_error "Collection script not found: $script_path"
        return 1
    fi
    
    if [[ ! -x "$script_path" ]]; then
        log_error "Collection script not executable: $script_path"
        return 1
    fi
    
    log_debug "Executing: $script_path"
    
    if ! "$script_path"; then
        log_error "$description failed"
        return 1
    fi
    
    log_success "$description completed"
    return 0
}

# Create the overall directory structure
setup_base_directories() {
    log_info "Setting up base directory structure..."
    
    ensure_directory "$MUST_GATHER_DIR"
    ensure_directory "$MUST_GATHER_DIR/rhdh"
    ensure_directory "$MUST_GATHER_DIR/logs"
    ensure_directory "$MUST_GATHER_DIR/events"
    
    log_success "Base directory structure created"
}

# Run the detection phase
run_detection_phase() {
    log_info "=== DETECTION PHASE ==="
    
    # Only detect RHDH deployments (cluster info available via generic must-gather)
    if ! run_collection_script "detect-rhdh" "RHDH deployment detection"; then
        log_warn "RHDH deployment detection completed with warnings (may not be deployed)"
    fi
    
    # Load detection results for use by other scripts
    load_detection_results
    
    log_info "Detection phase completed"
    log_info "RHDH Deployment Type: ${DEPLOYMENT_TYPE:-none}"
    log_info "RHDH Namespace: ${RHDH_NAMESPACE:-none}"
    
    return 0
}

# Run the collection phase
run_collection_phase() {
    log_info "=== COLLECTION PHASE ==="
    
    # Load detection results
    load_detection_results
    local deployment_type="${DEPLOYMENT_TYPE:-none}"
    local namespace="${RHDH_NAMESPACE:-}"
    
    # Only collect RHDH-specific data (cluster info available via generic oc adm must-gather)
    
    # Deployment-specific collection - check for ALL detected types
    local has_helm=false
    local has_operator=false
    
    # Check rhdh-instances.env for all deployment types
    if [[ -f "$MUST_GATHER_DIR/rhdh-instances.env" ]]; then
        if grep -q ":helm:" "$MUST_GATHER_DIR/rhdh-instances.env"; then
            has_helm=true
        fi
        if grep -q ":operator:" "$MUST_GATHER_DIR/rhdh-instances.env"; then
            has_operator=true
        fi
    fi
    
    # Collect from all detected deployment types
    if [[ "$has_helm" == "true" ]]; then
        log_info "Detected Helm deployment(s), collecting Helm-specific data..."
        if ! run_collection_script "collect-helm-data" "Helm data collection"; then
            log_error "Helm data collection failed"
        fi
    fi
    
    if [[ "$has_operator" == "true" ]]; then
        log_info "Detected Operator deployment(s), collecting Operator-specific data..."
        if ! run_collection_script "collect-operator-data" "Operator data collection"; then
            log_error "Operator data collection failed"
        fi
    fi
    
    if [[ "$has_helm" == "false" && "$has_operator" == "false" ]]; then
        log_warn "No RHDH deployment detected, skipping deployment-specific collection"
    fi
    
    # RHDH resources collection (optional, controlled by COLLECT_RESOURCES)
    local collect_resources="${COLLECT_RESOURCES:-false}"
    if [[ "$collect_resources" == "true" ]]; then
        if [[ -n "$namespace" ]]; then
            if ! run_collection_script "collect-rhdh-resources" "RHDH resources collection"; then
                log_error "RHDH resources collection failed"
            fi
        else
            log_warn "RHDH namespace not detected, skipping RHDH resource collection"
        fi
    else
        log_info "RHDH resources collection disabled (set COLLECT_RESOURCES=true to enable)"
    fi
    
    # Always collect logs and events
    if ! run_collection_script "collect-logs-events" "Logs and events collection"; then
        log_error "Logs and events collection failed"
    fi
    
    log_success "Collection phase completed"
}

# Run sanitization
run_sanitization_phase() {
    log_info "=== SANITIZATION PHASE ==="
    
    local sanitize_script="$SCRIPT_DIR/sanitize"
    
    if [[ -f "$sanitize_script" && -x "$sanitize_script" ]]; then
        log_info "Running data sanitization..."
        if ! "$sanitize_script" "$MUST_GATHER_DIR"; then
            log_warn "Data sanitization completed with warnings"
        else
            log_success "Data sanitization completed"
        fi
    else
        log_warn "Sanitization script not found or not executable: $sanitize_script"
    fi
}

# Generate final collection summary
generate_final_summary() {
    log_info "Generating final collection summary..."
    
    # Load detection results
    load_detection_results
    local deployment_type="${DEPLOYMENT_TYPE:-none}"
    local namespace="${RHDH_NAMESPACE:-none}"
    
    # Count collected files
    local total_files=$(find "$MUST_GATHER_DIR" -type f 2>/dev/null | wc -l || echo "0")
    local log_files=$(find "$MUST_GATHER_DIR" -name "*.log" -type f 2>/dev/null | wc -l || echo "0")
    local yaml_files=$(find "$MUST_GATHER_DIR" -name "*.yaml" -type f 2>/dev/null | wc -l || echo "0")
    
    cat > "$MUST_GATHER_DIR/collection-summary.txt" << EOF
RHDH Must-Gather Collection Summary
==================================
Collection Date: $(date)
Collection Tool Version: 1.0.0
Must-Gather Directory: $MUST_GATHER_DIR

Note: This tool collects only RHDH-specific data. For cluster-wide information,
use the generic OpenShift must-gather: oc adm must-gather

=== DETECTION RESULTS ===
RHDH Deployment Type: $deployment_type
RHDH Namespace: $namespace

=== COLLECTION STATISTICS ===
Total Files Collected: $total_files
Log Files: $log_files
YAML Files: $yaml_files

=== COLLECTED DATA ===
EOF

    if [[ "$deployment_type" != "none" && -n "$namespace" ]]; then
        cat >> "$MUST_GATHER_DIR/collection-summary.txt" << EOF
✓ RHDH-Specific Data:
  - All resources from namespace: $namespace
  - Pod logs (current and previous)
  - RHDH-specific events
$([[ "$deployment_type" == "helm" ]] && echo "  - Helm charts, values, and manifests" || echo "  - Operator and Custom Resources")
$([[ "$deployment_type" == "operator" ]] && echo "  - CRDs and Backstage Custom Resources")
$([[ "$deployment_type" == "operator" ]] && echo "  - OLM information (CSVs, Subscriptions)")

EOF
    else
        cat >> "$MUST_GATHER_DIR/collection-summary.txt" << EOF
⚠ RHDH-Specific Data:
  - No RHDH deployment detected
  - Only general cluster information collected
  - Manual investigation may be required

EOF
    fi

    cat >> "$MUST_GATHER_DIR/collection-summary.txt" << EOF

=== DATA ORGANIZATION ===
rhdh/                  # RHDH-specific data
├── resources/         # RHDH namespace resources
$([[ "$deployment_type" == "helm" ]] && echo "├── helm/              # Helm deployment data")
$([[ "$deployment_type" == "operator" ]] && echo "├── operator/          # Operator deployment data")
$([[ "$deployment_type" == "operator" ]] && echo "└── backstage-crs/     # Backstage Custom Resources")
logs/                  # RHDH pod and system logs
events/                # RHDH-related Kubernetes events

=== SECURITY NOTES ===
- Sensitive data has been automatically sanitized
- Secret data sections have been redacted
- Passwords, tokens, and keys have been masked
- Original files backed up before sanitization

=== COLLECTION STATUS ===
Collection completed successfully at $(date)

=== USAGE NOTES ===
- This collection focuses only on RHDH-specific resources
- For cluster-wide diagnostics, combine with generic must-gather:
  oc adm must-gather
- For complete troubleshooting, provide both collections to support

For support or analysis of this data, please provide this
entire directory to your support team or engineers.
EOF

    log_success "Final collection summary generated"
}

# Show collection progress
show_progress() {
    log_info "Must-gather collection progress:"
    echo "  1. ✓ Environment validation"
    echo "  2. ✓ Base directory setup"
    echo "  3. → Detection phase"
    echo "  4. → Collection phase"
    echo "  5. → Sanitization phase"
    echo "  6. → Summary generation"
}

# Main collection orchestrator
main() {
    log_info "Starting RHDH must-gather collection..."
    log_info "Output directory: $MUST_GATHER_DIR"
    log_info "Log level: $LOG_LEVEL"
    
    # Log time constraints if present
    log_time_constraints
    
    # Initialize must-gather environment
    if ! init_must_gather; then
        log_error "Failed to initialize must-gather environment"
        exit 1
    fi
    
    # Show progress
    show_progress
    
    # Setup base directories
    setup_base_directories
    
    # Run detection phase
    if ! run_detection_phase; then
        log_error "Detection phase failed"
        exit 1
    fi
    
    # Run collection phase
    if ! run_collection_phase; then
        log_error "Collection phase failed, but continuing..."
    fi
    
    # Run sanitization
    run_sanitization_phase
    
    # Generate final summary
    generate_final_summary
    
    # Cleanup
    cleanup_must_gather
    
    log_success "Must-gather collection completed successfully!"
    log_info "Collection summary: $MUST_GATHER_DIR/collection-summary.txt"
    log_info "Total data collected in: $MUST_GATHER_DIR"
    
    # Show final file count
    local final_file_count=$(find "$MUST_GATHER_DIR" -type f 2>/dev/null | wc -l || echo "0")
    log_info "Files collected: $final_file_count"
}

# Show help
show_help() {
    cat << EOF
RHDH Must-Gather Tool - Main Orchestrator

Usage: $0 [OPTIONS]

This is the main entry point for RHDH must-gather data collection.
It orchestrates the execution of multiple specialized collection scripts.

Options:
  -h, --help    Show this help message

Environment Variables:
  MUST_GATHER_DIR       Output directory (default: /must-gather)
  LOG_LEVEL            Logging level: DEBUG, INFO, WARN, ERROR (default: INFO)
  COLLECTION_TIMEOUT   Timeout for individual commands in seconds (default: 300)
  COLLECT_RESOURCES    Collect detailed RHDH resources (default: false)
  SINCE                Relative time for log/event collection (e.g., "2h", "30m")
  SINCE_TIME           Absolute timestamp for log/event collection (RFC3339)

Collection Phases:
  1. Detection Phase:
     - Detect RHDH deployment types and namespaces
     - Support multiple instances (Helm and Operator)
  
  2. Collection Phase:
     - Collect deployment-specific data (Helm or Operator)
     - Collect RHDH resources (optional, use COLLECT_RESOURCES=true)
     - Collect RHDH logs and events
     - Focus on RHDH-specific data only
  
  3. Sanitization Phase:
     - Remove or mask sensitive information
     - Redact secrets, tokens, and passwords
  
  4. Summary Generation:
     - Create comprehensive collection summary
     - Document what was collected and where

Examples:
  $0                              # Standard collection (logs, events, Helm/Operator data)
  COLLECT_RESOURCES=true $0       # Include detailed resource collection  
  SINCE=2h $0                     # Collect logs/events from last 2 hours
  LOG_LEVEL=DEBUG $0              # Debug mode
  MUST_GATHER_DIR=/tmp/rhdh $0    # Custom output directory

For more information about individual collection scripts, run:
  $0 [script-name] --help

Available collection scripts:
  - detect-cluster: Cluster type detection
  - detect-rhdh: RHDH deployment detection  
  - collect-cluster-info: Cluster information
  - collect-helm-data: Helm deployment data
  - collect-operator-data: Operator deployment data
  - collect-rhdh-resources: RHDH namespace resources
  - collect-logs-events: Logs and events
  - sanitize: Data sanitization
EOF
}

# Handle command line arguments
case "${1:-}" in
    -h|--help)
        show_help
        exit 0
        ;;
    detect-cluster|detect-rhdh|collect-cluster-info|collect-helm-data|collect-operator-data|collect-rhdh-resources|collect-logs-events|sanitize)
        # Allow running individual scripts
        script_name="$1"
        shift
        exec "$SCRIPT_DIR/$script_name" "$@"
        ;;
    *)
        # Default: run full collection
        main "$@"
        ;;
esac