name: PR container image build

on:
  # /!\ Warning: using the pull_request_target event to be able to read secrets. But using this event without the cautionary measures described below
  # may allow unauthorized GitHub users to open a “pwn request” and exfiltrate secrets.
  # As recommended in https://iterative.ai/blog/testing-external-contributions-using-github-actions-secrets,
  # we are adding an 'authorize' job that checks if the workflow was triggered from a fork PR. In that case, the "external" environment
  # will prevent the job from running until it's approved manually by human intervention.
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main
      - release-1.[0-9]+

env:
  IMAGE_NAME: ${{ vars.REGISTRY_ORG }}/rhdh-must-gather

jobs:
  authorize:
    # The 'external' environment is configured with the repo maintainers team as required reviewers.
    # All the subsequent jobs in this workflow 'need' this job, which will require manual approval for PRs coming from external forks.
    # see list of approvers in OWNERS file
    environment:
      ${{ (github.event.pull_request.head.repo.full_name == github.repository ||
      contains(fromJSON('["gazarenkov","nickboldt","rm3l","kim-tsao","kadel","Fortune-Ndlovu","subhashkhileri","zdrapela","openshift-cherrypick-robot"]'), github.event.pull_request.user.login)) && 'internal' || 'external' }}
    runs-on: ubuntu-latest
    steps:
      - name: approved
        run: |
          echo "✓"

  pr-image-publish:
    name: Publish PR Container Image
    runs-on: ubuntu-latest
    needs: authorize
    permissions:
      contents: read
      packages: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          fetch-depth: 0
          repository: ${{github.event.pull_request.head.repo.full_name}}
          ref: ${{ github.event.pull_request.head.sha }}

      # check changes in this commit for regex include and exclude matches
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47.0.0
        with:
          files: |
            .github/workflows/pr-container-build.yaml
            Makefile
            Dockerfile
            .containerignore
            collection-scripts/**
            LICENSE
          files_ignore: |
            **/*.md
            **/*.adoc
            examples/**

      - name: List all changed files (for troubleshooting)
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          for file in ${ALL_CHANGED_FILES}; do
            echo "$file was changed"
          done

      # Login to Quay.io (only for PRs from same repo)
      # https://github.com/docker/login-action
      - name: Log into registry ${{ vars.REGISTRY }}
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.5.0
        with:
          registry: ${{ vars.REGISTRY }}
          username: ${{ vars.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_TOKEN }}

      # Install the cosign tool
      # https://github.com/sigstore/cosign-installer
      - name: Install cosign
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: sigstore/cosign-installer@d58896d6a1865668819e1d91763c7751a165e159 #v3.9.2
        with:
          cosign-release: 'v2.2.4'

      # Generate image tags and build args
      - name: Prepare build variables
        if: steps.changed-files.outputs.any_changed == 'true'
        id: prep
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          SHORT_SHA=$(git rev-parse --short=9 HEAD)
          VERSION="0.0.0-$(git describe --no-match --always --abbrev=9 --dirty --broken 2>/dev/null || echo unknown)"
          
          echo "IMAGE_TAG=pr-${PR_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "EXTRA_TAGS=pr-${PR_NUMBER}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "LABELS=--label quay.expires-after=2w" >> "$GITHUB_OUTPUT"
          echo "BUILD_ARGS=--build-arg RHDH_MUST_GATHER_VERSION=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "VERSION=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build and push main tag
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          make build-push \
            CONTAINER_TOOL=docker \
            REGISTRY=${{ vars.REGISTRY }} \
            IMAGE_NAME=${{ env.IMAGE_NAME}} \
            IMAGE_TAG=${{ steps.prep.outputs.IMAGE_TAG }} \
            BUILD_ARGS="${{ steps.prep.outputs.BUILD_ARGS }}" \
            LABELS="${{ steps.prep.outputs.LABELS }}"

      # Build and push extra tag with commit SHA
      - name: Build and push extra tag with commit SHA
        if: steps.changed-files.outputs.any_changed == 'true' && steps.prep.outputs.EXTRA_TAGS != ''
        run: |
          make build-push \
            CONTAINER_TOOL=docker \
            REGISTRY=${{ vars.REGISTRY }} \
            IMAGE_NAME=${{ env.IMAGE_NAME}} \
            IMAGE_TAG=${{ steps.prep.outputs.EXTRA_TAGS }} \
            BUILD_ARGS="${{ steps.prep.outputs.BUILD_ARGS }}" \
            LABELS="${{ steps.prep.outputs.LABELS }}"

      # Sign the published Docker images (only for same-repo PRs)
      # https://github.com/sigstore/cosign
      - name: Sign the published Docker images
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          # Get digest for signing
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ vars.REGISTRY }}/${{ env.IMAGE_NAME}}:${{ steps.prep.outputs.IMAGE_TAG }} | cut -d'@' -f2)
          
          # Sign the main tag
          echo "Signing ${{ vars.REGISTRY }}/${{ env.IMAGE_NAME}}:${{ steps.prep.outputs.IMAGE_TAG }}@${DIGEST}"
          cosign sign --yes "${{ vars.REGISTRY }}/${{ env.IMAGE_NAME}}:${{ steps.prep.outputs.IMAGE_TAG }}@${DIGEST}"
          
          # Sign the extra tag if it exists
          if [ -n "${{ steps.prep.outputs.EXTRA_TAGS }}" ]; then
            echo "Signing ${{ vars.REGISTRY }}/${{ env.IMAGE_NAME}}:${{ steps.prep.outputs.EXTRA_TAGS }}@${DIGEST}"
            cosign sign --yes "${{ vars.REGISTRY }}/${{ env.IMAGE_NAME}}:${{ steps.prep.outputs.EXTRA_TAGS }}@${DIGEST}"
          fi

      - name: Summary
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "### Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.prep.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Number**: ${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ✅ Built, pushed, and signed" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags**: \`pr-${{ github.event.pull_request.number }}\`, \`${{ steps.prep.outputs.EXTRA_TAGS }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Expiry**: 2 weeks" >> $GITHUB_STEP_SUMMARY
